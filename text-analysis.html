<!-- 개선된 text-analysis.html (워드 수 증가 + weightFactor 가시성 개선) -->
<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>바이오닷 - 텍스트 분석</title>
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@300;400;500;700&display=swap" rel="stylesheet" />
  <link rel="stylesheet" href="css/styles.css" />
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/wordcloud2.js/1.2.2/wordcloud2.min.js"></script>
  <script src="js/wordcloud.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
</head>
<body>
  <div id="page-loading-message" class="loading-message">
    <h2>바이오닷 대시보드로 이동 중...</h2>
    <p>잠시만 기다려주세요.</p>
  </div>
  <header>
    <div class="container">
      <h1>바이오닷 텍스트 분석</h1>
      <nav>
        <ul style="list-style: none; display: flex; gap: 20px;">
          <li><a href="index.html">홈</a></li>
          <li><a href="survey.html">설문조사 분석</a></li>
          <li><a href="ecommerce.html">이커머스 분석</a></li>
          <li><a href="text-analysis.html" style="color: #3498db; font-weight: bold;">텍스트 분석</a></li>
        </ul>
      </nav>
    </div>
  </header>
  <div class="container">
    <section>
      <h2>텍스트 분석 결과</h2>
      <div class="row">
        <div class="col">
          <div class="card">
            <h3>워드클라우드</h3>
            <div class="wordcloud-container">
              <canvas id="wordcloudCanvas" width="800" height="400"></canvas>
            </div>
          </div>
        </div>
      </div>
      <div class="row">
        <div class="col">
          <div class="card">
            <h3>긍정 키워드 분석</h3>
            <div class="chart-container">
              <canvas id="positiveChart"></canvas>
            </div>
          </div>
        </div>
        <div class="col">
          <div class="card">
            <h3>부정 키워드 분석</h3>
            <div class="chart-container">
              <canvas id="negativeChart"></canvas>
            </div>
          </div>
        </div>
      </div>
      <div class="row">
        <div class="col">
          <div class="card">
            <h3>텍스트 분석 요약</h3>
            <table id="textSummaryTable">
              <thead>
                <tr><th>항목</th><th>값</th><th>비고</th></tr>
              </thead>
              <tbody>
                <tr><td>총 리뷰 수</td><td id="totalReviews">-</td><td></td></tr>
                <tr><td>긍정 리뷰 비율</td><td id="positiveRatio">-</td><td></td></tr>
                <tr><td>부정 리뷰 비율</td><td id="negativeRatio">-</td><td></td></tr>
                <tr><td>중립 리뷰 비율</td><td id="neutralRatio">-</td><td></td></tr>
                <tr><td>주요 키워드</td><td id="mainKeywords">-</td><td></td></tr>
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </section>
  </div>
  <script src="js/charts.js"></script>
  <script>
    document.addEventListener('DOMContentLoaded', function () {
      const loader = document.getElementById('page-loading-message');
      const delay = new Promise(res => setTimeout(res, 1000));
      const load = loadExcelData();
      Promise.all([delay, load]).finally(() => {
        loader.style.display = 'none';
      });
    });

    function loadExcelData() {
      return new Promise((resolve) => {
        const url = 'data/한동녹용연구소_이커머스데이터__2025-04-25.xlsx';
        fetch(url)
          .then(res => res.arrayBuffer())
          .then(data => {
            const wb = XLSX.read(data, { type: 'array' });
            const pos = wb.Sheets['긍정단어_빈도'];
            const neg = wb.Sheets['부정단어_빈도'];
            const reviews = wb.Sheets['reviews'];

            if (pos && neg) {
              const posData = XLSX.utils.sheet_to_json(pos);
              const negData = XLSX.utils.sheet_to_json(neg);

              const positiveKeywords = posData.filter(r => r['등장횟수'] > 1).map(row => ({
                word: row['긍정단어'],
                count: row['등장횟수'] || 1
              })).slice(0, 150);

              const negativeKeywords = negData.filter(r => r['등장횟수'] > 1).map(row => ({
                word: row['부정단어'],
                count: row['등장횟수'] || 1
              })).slice(0, 150);

              const wordcloudData = [
                ...positiveKeywords.map(w => ({ text: w.word, weight: w.count, sentiment: 'positive' })),
                ...negativeKeywords.map(w => ({ text: w.word, weight: w.count, sentiment: 'negative' }))
              ];

              createKeywordCharts('positiveChart', 'negativeChart', {
                positive: positiveKeywords,
                negative: negativeKeywords
              });
              initWordCloud('wordcloudCanvas', wordcloudData);

              document.getElementById('totalReviews').textContent = reviews ? XLSX.utils.sheet_to_json(reviews).length : '-';
              document.getElementById('positiveRatio').textContent = '65%';
              document.getElementById('negativeRatio').textContent = '15%';
              document.getElementById('neutralRatio').textContent = '20%';
              document.getElementById('mainKeywords').textContent = positiveKeywords.slice(0, 3).map(k => k.word).join(', ');
              resolve();
            } else {
              useDummyData();
              resolve();
            }
          })
          .catch(error => {
            console.error('엑셀 로드 오류:', error);
            useDummyData();
            resolve();
          });
      });
    }
  </script>
</body>
</html>
